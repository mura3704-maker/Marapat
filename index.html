<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–ê–†–ê–ü–ê–¢ - –ê—É–¥–∞–Ω–¥—ã“õ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar-link.active { background-color: #3b82f6; color: white; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .filter-checkbox:checked + label {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .rating-tab.active {
            border-bottom: 3px solid #3b82f6;
            color: #3b82f6;
        }

        .rating-item { transition: all 0.2s ease; }
        .rating-item:hover { transform: translateX(5px); border-color: #3b82f6; }

        .stat-card-mini {
            transition: all 0.3s ease;
            border: 1px solid #f1f5f9;
        }
        .stat-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom scrollbar for database lists */
        .db-list-scroll::-webkit-scrollbar { width: 4px; }
        .db-list-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .db-list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

<div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="w-full md:w-64 bg-white border-r border-slate-200 p-4 space-y-4 hidden md:block">
        <div class="flex items-center space-x-2 px-4 py-6">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i class="fas fa-award text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">–ú–ê–†–ê–ü–ê–¢</h1>
        </div>
        
        <nav class="space-y-1">
            <button onclick="switchTab('dashboard')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 active">
                <i class="fas fa-chart-pie w-5"></i>
                <span>–ë–∞—Å—Ç—ã –±–µ—Ç</span>
            </button>
            <button onclick="switchTab('database')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-database w-5"></i>
                <span>–ë–∞–∑–∞–Ω—ã —Ç–æ–ª—Ç—ã—Ä—É</span>
            </button>
            <button onclick="switchTab('add-achievement')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-plus-circle w-5"></i>
                <span>–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ “õ–æ—Å—É</span>
            </button>
            <button onclick="switchTab('ratings')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-trophy w-5"></i>
                <span>–†–µ–π—Ç–∏–Ω–≥—Ç–µ—Ä</span>
            </button>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <!-- Dashboard -->
        <section id="tab-dashboard" class="tab-content space-y-6 pb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-6 border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-slate-500">–û“õ—É—à—ã–ª–∞—Ä</p>
                    <h3 id="stat-students" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-medium text-slate-500">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</p>
                    <h3 id="stat-teachers" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-purple-500">
                    <p class="text-sm font-medium text-slate-500">–ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä</p>
                    <h3 id="stat-achievements" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-orange-500">
                    <p class="text-sm font-medium text-slate-500">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</p>
                    <h3 id="stat-schools" class="text-2xl font-bold mt-1">0</h3>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800">–°–æ“£“ì—ã —Ç—ñ—Ä–∫–µ–ª–≥–µ–Ω –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">–ò–µ—Å—ñ / –ñ–∞—Ä—ã—Å</th>
                                <th class="px-6 py-3">–ú–µ–∫—Ç–µ–ø</th>
                                <th class="px-6 py-3">–î–µ“£–≥–µ–π</th>
                                <th class="px-6 py-3 text-right">–ë–∞–ª–ª</th>
                                <th class="px-6 py-3 text-center">üóëÔ∏è</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table" class="divide-y divide-slate-100 text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Database -->
        <section id="tab-database" class="tab-content hidden space-y-6 pb-12">
             <h2 class="text-2xl font-bold text-slate-800">–ë–∞–∑–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É</h2>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Schools -->
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-blue-600">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</h3>
                    <div class="flex space-x-2 mb-4">
                        <input id="in-school" type="text" placeholder="–ú–µ–∫—Ç–µ–ø –∞—Ç–∞—É—ã" class="flex-1 border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('schools')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold">“ö–æ—Å—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-schools" class="space-y-2 pr-2"></ul></div>
                </div>
                <!-- Teachers -->
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-green-600">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</h3>
                    <div class="space-y-3 mb-4">
                        <select id="sel-school-teacher" class="w-full border p-2 rounded text-sm outline-none"></select>
                        <input id="in-teacher-name" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ" class="w-full border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('teachers')" class="w-full bg-green-600 text-white py-2 rounded text-sm font-semibold">–°–∞“õ—Ç–∞—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-teachers" class="space-y-2 pr-2"></ul></div>
                </div>
                <!-- Students -->
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-purple-600">–û“õ—É—à—ã–ª–∞—Ä</h3>
                    <div class="space-y-3 mb-4">
                        <select id="sel-school-student" class="w-full border p-2 rounded text-sm outline-none"></select>
                        <input id="in-student-name" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ" class="w-full border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('students')" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-semibold">–°–∞“õ—Ç–∞—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-students" class="space-y-2 pr-2"></ul></div>
                </div>
             </div>
        </section>

        <!-- Achievement Add -->
        <section id="tab-add-achievement" class="tab-content hidden max-w-xl mx-auto pb-12">
            <div class="card p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center">–ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç—ñ —Ç—ñ—Ä–∫–µ—É</h2>
                <div class="space-y-4">
                    <label class="text-xs font-bold text-slate-400 uppercase">–ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑</label>
                    <select id="sel-school-final" class="w-full border p-3 rounded-lg outline-none bg-blue-50"></select>
                    
                    <label class="text-xs font-bold text-slate-400 uppercase">–ò–µ—Å—ñ (–û“õ—É—à—ã –Ω–µ–º–µ—Å–µ –ú“±“ì–∞–ª—ñ–º)</label>
                    <input id="in-owner-name" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ–Ω –µ–Ω–≥—ñ–∑—ñ“£—ñ–∑" class="w-full border p-3 rounded-lg outline-none">
                    
                    <label class="text-xs font-bold text-slate-400 uppercase">–ñ–∞—Ä—ã—Å –º”ô–ª—ñ–º–µ—Ç—Ç–µ—Ä—ñ</label>
                    <input id="in-comp-name" type="text" placeholder="–ñ–∞—Ä—ã—Å –∞—Ç–∞—É—ã (–º—ã—Å–∞–ª—ã: –ó–µ—Ä–¥–µ)" class="w-full border p-3 rounded-lg outline-none">
                    
                    <select id="sel-level" class="w-full border p-3 rounded-lg outline-none">
                        <option value="100">–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ (100 –±–∞–ª–ª)</option>
                        <option value="80">–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ (80 –±–∞–ª–ª)</option>
                        <option value="60">–û–±–ª—ã—Å—Ç—ã“õ (60 –±–∞–ª–ª)</option>
                        <option value="40">–ê—É–¥–∞–Ω–¥—ã“õ (40 –±–∞–ª–ª)</option>
                    </select>
                    
                    <button onclick="registerAchievement()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all">–ú”ô–ª—ñ–º–µ—Ç—Ç—ñ —Å–∞“õ—Ç–∞—É</button>
                </div>
            </div>
        </section>

        <!-- Ratings -->
        <section id="tab-ratings" class="tab-content hidden space-y-6 pb-20">
            <!-- –î–ï“¢–ì–ï–ô–õ–ï–† –ë–û–ô–´–ù–®–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ê -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card-mini card p-4 border-t-4 border-red-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ</p>
                    <h4 id="stat-intl" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-blue-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ</p>
                    <h4 id="stat-rep" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-green-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">–û–±–ª—ã—Å—Ç—ã“õ</p>
                    <h4 id="stat-reg" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-orange-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">–ê—É–¥–∞–Ω–¥—ã“õ</p>
                    <h4 id="stat-dist" class="text-xl font-black text-slate-800">0</h4>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex border-b border-slate-100 mb-6 overflow-x-auto">
                    <button onclick="setRatingView('school')" id="rtab-school" class="rating-tab px-6 py-3 font-bold text-sm transition-all active">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</button>
                    <button onclick="setRatingView('teacher')" id="rtab-teacher" class="rating-tab px-6 py-3 font-bold text-sm transition-all">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</button>
                    <button onclick="setRatingView('student')" id="rtab-student" class="rating-tab px-6 py-3 font-bold text-sm transition-all">–û“õ—É—à—ã–ª–∞—Ä</button>
                </div>
                
                <div class="mb-6 flex flex-wrap gap-3 items-center">
                    <span class="text-xs font-bold text-slate-400 uppercase">–°“Ø–∑–≥—ñ:</span>
                    <div class="flex flex-wrap gap-2">
                        <input type="checkbox" id="f-intl" class="filter-checkbox hidden" checked onchange="renderAll()">
                        <label for="f-intl" class="px-3 py-1.5 rounded-full border border-slate-200 text-[10px] font-bold cursor-pointer transition-all">–•–ê–õ–´“ö–ê–†.</label>
                        
                        <input type="checkbox" id="f-rep" class="filter-checkbox hidden" checked onchange="renderAll()">
                        <label for="f-rep" class="px-3 py-1.5 rounded-full border border-slate-200 text-[10px] font-bold cursor-pointer transition-all">–†–ï–°–ü–£–ë.</label>
                        
                        <input type="checkbox" id="f-reg" class="filter-checkbox hidden" checked onchange="renderAll()">
                        <label for="f-reg" class="px-3 py-1.5 rounded-full border border-slate-200 text-[10px] font-bold cursor-pointer transition-all">–û–ë–õ–´–°.</label>
                        
                        <input type="checkbox" id="f-dist" class="filter-checkbox hidden" checked onchange="renderAll()">
                        <label for="f-dist" class="px-3 py-1.5 rounded-full border border-slate-200 text-[10px] font-bold cursor-pointer transition-all">–ê–£–î–ê–ù.</label>
                    </div>
                </div>

                <div id="rating-list-container" class="space-y-3"></div>
            </div>
        </section>
    </main>
</div>

<!-- Simple Notification -->
<div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl opacity-0 transition-all duration-300 z-[70] pointer-events-none"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase configuration - will be provided by environment or hardcoded here
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'marapat-district-v1';

    let user = null;
    let data = { schools: [], teachers: [], students: [], achievements: [] };
    let currentRatingView = 'school';

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch(e) { console.error("Firebase Auth Error:", e); }
    };
    initAuth();

    onAuthStateChanged(auth, u => {
        user = u;
        if (user) setupListeners();
    });

    function setupListeners() {
        const publicPath = (coll) => collection(db, 'artifacts', appId, 'public', 'data', coll);
        
        onSnapshot(publicPath('schools'), s => { data.schools = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); });
        onSnapshot(publicPath('teachers'), s => { data.teachers = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); });
        onSnapshot(publicPath('students'), s => { data.students = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); });
        onSnapshot(publicPath('achievements'), s => { data.achievements = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); });
    }

    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById(`tab-${id}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const btn = Array.from(document.querySelectorAll('.sidebar-link')).find(b => b.getAttribute('onclick').includes(id));
        if (btn) btn.classList.add('active');
    };

    window.setRatingView = (v) => {
        currentRatingView = v;
        document.querySelectorAll('.rating-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`rtab-${v}`).classList.add('active');
        renderAll();
    };

    window.saveToCloud = async (type) => {
        if (!user) return;
        const collRef = collection(db, 'artifacts', appId, 'public', 'data', type);
        
        if (type === 'schools') {
            const name = document.getElementById('in-school').value.trim();
            if (name) { await addDoc(collRef, { name }); document.getElementById('in-school').value = ''; }
        } else if (type === 'teachers') {
            const name = document.getElementById('in-teacher-name').value.trim();
            const school = document.getElementById('sel-school-teacher').value;
            if (name && school) { await addDoc(collRef, { name, school }); document.getElementById('in-teacher-name').value = ''; }
        } else if (type === 'students') {
            const name = document.getElementById('in-student-name').value.trim();
            const school = document.getElementById('sel-school-student').value;
            if (name && school) { await addDoc(collRef, { name, school }); document.getElementById('in-student-name').value = ''; }
        }
        showToast("–ú”ô–ª—ñ–º–µ—Ç –±–∞–∑–∞“ì–∞ —Å–∞“õ—Ç–∞–ª–¥—ã");
    };

    window.registerAchievement = async () => {
        const sch = document.getElementById('sel-school-final').value;
        const owner = document.getElementById('in-owner-name').value.trim();
        const comp = document.getElementById('in-comp-name').value.trim();
        const score = parseInt(document.getElementById('sel-level').value);
        const lvl = document.getElementById('sel-level').options[document.getElementById('sel-level').selectedIndex].text.split(' ')[0];
        
        if (!sch || !owner || !comp) { showToast("–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑"); return; }

        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'achievements'), {
            school: sch,
            ownerName: owner,
            competitionName: comp,
            level: lvl,
            score: score,
            timestamp: Date.now()
        });

        document.getElementById('in-owner-name').value = '';
        document.getElementById('in-comp-name').value = '';
        showToast("–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ —Å”ô—Ç—Ç—ñ —Ç—ñ—Ä–∫–µ–ª–¥—ñ");
        switchTab('dashboard');
    };

    window.renderAll = () => {
        // Stats update
        document.getElementById('stat-students').innerText = data.students.length;
        document.getElementById('stat-teachers').innerText = data.teachers.length;
        document.getElementById('stat-schools').innerText = data.schools.length;
        document.getElementById('stat-achievements').innerText = data.achievements.length;

        // Level Stats in Ratings (RESTORED)
        document.getElementById('stat-intl').innerText = data.achievements.filter(a => a.level.includes('–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ')).length;
        document.getElementById('stat-rep').innerText = data.achievements.filter(a => a.level.includes('–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ')).length;
        document.getElementById('stat-reg').innerText = data.achievements.filter(a => a.level.includes('–û–±–ª—ã—Å—Ç—ã“õ')).length;
        document.getElementById('stat-dist').innerText = data.achievements.filter(a => a.level.includes('–ê—É–¥–∞–Ω–¥—ã“õ')).length;

        // Populate selects
        const schList = [...data.schools].sort((a,b) => a.name.localeCompare(b.name));
        const schOpts = '<option value="" disabled selected>–ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑</option>' + schList.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        ['sel-school-teacher', 'sel-school-student', 'sel-school-final'].forEach(id => {
            const el = document.getElementById(id);
            if (el && (el.innerHTML === "" || el.children.length <= 1)) el.innerHTML = schOpts;
        });

        // DB Lists
        document.getElementById('list-schools').innerHTML = data.schools.map(s => `<li class="p-2 border rounded flex justify-between items-center text-xs bg-white"><span>${s.name}</span><button onclick="removeItem('schools','${s.id}')" class="text-slate-300 hover:text-red-500">‚ùå</button></li>`).join('');
        document.getElementById('list-teachers').innerHTML = data.teachers.map(t => `<li class="p-2 border rounded flex justify-between items-center text-xs bg-white"><span>${t.name} (${t.school})</span><button onclick="removeItem('teachers','${t.id}')" class="text-slate-300 hover:text-red-500">‚ùå</button></li>`).join('');
        document.getElementById('list-students').innerHTML = data.students.map(s => `<li class="p-2 border rounded flex justify-between items-center text-xs bg-white"><span>${s.name} (${s.school})</span><button onclick="removeItem('students','${s.id}')" class="text-slate-300 hover:text-red-500">‚ùå</button></li>`).join('');

        // Rating calculation
        const filters = {
            '–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ': document.getElementById('f-intl').checked,
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ': document.getElementById('f-rep').checked,
            '–û–±–ª—ã—Å—Ç—ã“õ': document.getElementById('f-reg').checked,
            '–ê—É–¥–∞–Ω–¥—ã“õ': document.getElementById('f-dist').checked
        };

        const scoreMap = {};
        data.achievements.filter(a => filters[a.level]).forEach(a => {
            const key = (currentRatingView === 'school') ? a.school : a.ownerName;
            scoreMap[key] = (scoreMap[key] || 0) + a.score;
        });

        const sortedScores = Object.entries(scoreMap).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list-container').innerHTML = sortedScores.map((r, i) => `
            <div class="flex justify-between items-center p-4 bg-white border border-slate-100 rounded-xl rating-item shadow-sm">
                <div class="flex items-center space-x-3">
                    <span class="font-bold text-blue-600 w-6">${i+1}</span>
                    <span class="font-medium text-slate-700">${r[0]}</span>
                </div>
                <div class="font-black text-blue-600">${r[1]} <span class="text-[10px] text-slate-400 uppercase">–±–∞–ª–ª</span></div>
            </div>
        `).join('') || '<p class="text-center py-10 text-slate-400 text-sm">–ë“±–ª —Å–∞–Ω–∞—Ç—Ç–∞ –¥–µ—Ä–µ–∫—Ç–µ—Ä –∂–æ“õ</p>';

        // Dashboard table
        document.getElementById('activity-table').innerHTML = [...data.achievements].sort((a,b) => b.timestamp - a.timestamp).slice(0, 8).map(a => `
            <tr class="hover:bg-slate-50">
                <td class="px-6 py-3"><b>${a.ownerName}</b><br><small class="text-slate-400 text-[10px]">${a.competitionName}</small></td>
                <td class="px-6 py-3 text-slate-600">${a.school}</td>
                <td class="px-6 py-3"><span class="px-2 py-0.5 bg-slate-100 rounded text-[10px] font-bold">${a.level}</span></td>
                <td class="px-6 py-3 text-right font-bold text-blue-600">+${a.score}</td>
                <td class="px-6 py-3 text-center"><button onclick="removeItem('achievements','${a.id}')" class="text-slate-300 hover:text-red-500">üóëÔ∏è</button></td>
            </tr>
        `).join('');
    };

    window.removeItem = async (coll, id) => {
        if (confirm('–ë“±–ª –º”ô–ª—ñ–º–µ—Ç—Ç—ñ ”©—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?')) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
            showToast("”®—à—ñ—Ä—ñ–ª–¥—ñ");
        }
    };

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.opacity = '1';
        t.style.transform = 'translateY(-10px)';
        setTimeout(() => { t.style.opacity = '0'; t.style.transform = 'translateY(0)'; }, 3000);
    }
</script>
</body>
</html>
