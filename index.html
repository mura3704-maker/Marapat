<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–ê–†–ê–ü–ê–¢ - –ê—É–¥–∞–Ω–¥—ã“õ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .sidebar-link.active { background-color: #3b82f6; color: white; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .filter-checkbox:checked + label { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .rating-tab.active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
        .rating-item { transition: all 0.2s ease; }
        .rating-item:hover { transform: translateX(5px); border-color: #3b82f6; }

        .stat-card-mini { transition: all 0.3s ease; border: 1px solid #f1f5f9; }
        .stat-card-mini:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        
        .db-list-scroll::-webkit-scrollbar { width: 4px; }
        .db-list-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

<div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- Mobile Header -->
    <div class="md:hidden bg-white p-4 border-b flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i class="fas fa-award"></i></div>
            <span class="font-bold">–ú–ê–†–ê–ü–ê–¢</span>
        </div>
        <button onclick="document.getElementById('sidebar').classList.toggle('hidden')" class="p-2"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-full md:w-64 bg-white border-r border-slate-200 p-4 space-y-4 hidden md:block">
        <div class="hidden md:flex items-center space-x-2 px-4 py-6">
            <div class="bg-blue-600 p-2 rounded-lg text-white"><i class="fas fa-award text-2xl"></i></div>
            <h1 class="text-xl font-bold text-slate-800">–ú–ê–†–ê–ü–ê–¢</h1>
        </div>
        
        <nav class="space-y-1">
            <button onclick="switchTab('dashboard')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 active">
                <i class="fas fa-chart-pie w-5"></i><span>–ë–∞—Å—Ç—ã –±–µ—Ç</span>
            </button>
            <button onclick="switchTab('database')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-database w-5"></i><span>–ë–∞–∑–∞</span>
            </button>
            <button onclick="switchTab('add-achievement')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-plus-circle w-5"></i><span>–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ “õ–æ—Å—É</span>
            </button>
            <button onclick="switchTab('ratings')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100">
                <i class="fas fa-trophy w-5"></i><span>–†–µ–π—Ç–∏–Ω–≥—Ç–µ—Ä</span>
            </button>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <!-- Dashboard -->
        <section id="tab-dashboard" class="tab-content space-y-6 pb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-6 border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-slate-500">–û“õ—É—à—ã–ª–∞—Ä</p>
                    <h3 id="stat-students" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-medium text-slate-500">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</p>
                    <h3 id="stat-teachers" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-purple-500">
                    <p class="text-sm font-medium text-slate-500">–ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä</p>
                    <h3 id="stat-achievements" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-orange-500">
                    <p class="text-sm font-medium text-slate-500">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</p>
                    <h3 id="stat-schools" class="text-2xl font-bold mt-1">0</h3>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800">–°–æ“£“ì—ã —Ç—ñ—Ä–∫–µ–ª–≥–µ–Ω –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">–ò–µ—Å—ñ / –ñ–∞—Ä—ã—Å</th>
                                <th class="px-6 py-3">–ú–µ–∫—Ç–µ–ø</th>
                                <th class="px-6 py-3 text-center">–¢“Ø—Ä—ñ</th>
                                <th class="px-6 py-3 text-right">–ë–∞–ª–ª</th>
                                <th class="px-6 py-3 text-center"></th>
                            </tr>
                        </thead>
                        <tbody id="activity-table" class="divide-y divide-slate-100 text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Database -->
        <section id="tab-database" class="tab-content hidden space-y-6 pb-12">
             <h2 class="text-2xl font-bold text-slate-800">–ë–∞–∑–∞–Ω—ã –±–∞—Å“õ–∞—Ä—É</h2>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-blue-600">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</h3>
                    <div class="flex space-x-2 mb-4">
                        <input id="in-school" type="text" placeholder="–ú–µ–∫—Ç–µ–ø –∞—Ç–∞—É—ã" class="flex-1 border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('schools')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm font-semibold">“ö–æ—Å—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-schools" class="space-y-2 pr-2"></ul></div>
                </div>
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-green-600">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</h3>
                    <div class="space-y-3 mb-4">
                        <select id="sel-school-teacher" class="w-full border p-2 rounded text-sm outline-none"></select>
                        <input id="in-teacher-name" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ" class="w-full border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('teachers')" class="w-full bg-green-600 text-white py-2 rounded text-sm font-semibold">–°–∞“õ—Ç–∞—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-teachers" class="space-y-2 pr-2"></ul></div>
                </div>
                <div class="card p-6 flex flex-col h-[450px]">
                    <h3 class="font-bold mb-4 text-purple-600">–û“õ—É—à—ã–ª–∞—Ä</h3>
                    <div class="space-y-3 mb-4">
                        <select id="sel-school-student" class="w-full border p-2 rounded text-sm outline-none"></select>
                        <input id="in-student-name" type="text" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ" class="w-full border p-2 rounded text-sm outline-none">
                        <button onclick="saveToCloud('students')" class="w-full bg-purple-600 text-white py-2 rounded text-sm font-semibold">–°–∞“õ—Ç–∞—É</button>
                    </div>
                    <div class="flex-1 overflow-y-auto db-list-scroll"><ul id="list-students" class="space-y-2 pr-2"></ul></div>
                </div>
             </div>
        </section>

        <!-- Add Achievement -->
        <section id="tab-add-achievement" class="tab-content hidden max-w-xl mx-auto pb-12">
            <div class="card p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center">–ñ–µ—Ç—ñ—Å—Ç—ñ–∫—Ç—ñ —Ç—ñ—Ä–∫–µ—É</h2>
                <div class="space-y-4">
                    <label class="block text-sm font-bold text-slate-600">1. –ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑:</label>
                    <select id="sel-school-filter" onchange="updateOwnerList()" class="w-full border p-3 rounded-lg outline-none bg-blue-50">
                        <option value="">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä —Ç—ñ–∑—ñ–º—ñ...</option>
                    </select>

                    <label class="block text-sm font-bold text-slate-600">2. –ö—ñ–º–Ω—ñ“£ –∂–µ—Ç—ñ—Å—Ç—ñ–≥—ñ:</label>
                    <div class="flex space-x-2">
                        <button onclick="setOwnerType('student')" id="btn-type-student" class="flex-1 py-2 px-4 rounded-lg border-2 border-blue-600 bg-blue-600 text-white font-bold transition-all">–û“õ—É—à—ã</button>
                        <button onclick="setOwnerType('teacher')" id="btn-type-teacher" class="flex-1 py-2 px-4 rounded-lg border-2 border-slate-200 text-slate-400 font-bold transition-all">–ú“±“ì–∞–ª—ñ–º</button>
                    </div>

                    <label class="block text-sm font-bold text-slate-600">3. –ê–¥–∞–º–¥—ã —Ç–∞“£–¥–∞“£—ã–∑:</label>
                    <select id="sel-owner-final" class="w-full border p-3 rounded-lg outline-none">
                        <option value="">–ê–ª–¥—ã–º–µ–Ω –º–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑...</option>
                    </select>
                    
                    <label class="block text-sm font-bold text-slate-600">–ñ–∞—Ä—ã—Å –∞—Ç–∞—É—ã:</label>
                    <input id="in-comp-name" type="text" placeholder="–ú—ã—Å–∞–ª—ã: –û–ª–∏–º–ø–∏—è–¥–∞, –ê“õ–±–æ—Ç–∞" class="w-full border p-3 rounded-lg outline-none">
                    
                    <label class="block text-sm font-bold text-slate-600">–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ –¥–µ“£–≥–µ–π—ñ:</label>
                    <select id="sel-level" class="w-full border p-3 rounded-lg outline-none">
                        <option value="100">–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ (100 –±–∞–ª–ª)</option>
                        <option value="80">–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ (80 –±–∞–ª–ª)</option>
                        <option value="60">–û–±–ª—ã—Å—Ç—ã“õ (60 –±–∞–ª–ª)</option>
                        <option value="40">–ê—É–¥–∞–Ω–¥—ã“õ (40 –±–∞–ª–ª)</option>
                    </select>
                    
                    <button onclick="registerAchievement()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg mt-4">–ú”ô–ª—ñ–º–µ—Ç—Ç—ñ —Å–∞“õ—Ç–∞—É</button>
                </div>
            </div>
        </section>

        <!-- Ratings -->
        <section id="tab-ratings" class="tab-content hidden space-y-6 pb-20">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="stat-card-mini card p-4 border-t-4 border-red-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ</p>
                    <h4 id="stat-intl" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-blue-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ</p>
                    <h4 id="stat-rep" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-green-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">–û–±–ª—ã—Å—Ç—ã“õ</p>
                    <h4 id="stat-reg" class="text-xl font-black text-slate-800">0</h4>
                </div>
                <div class="stat-card-mini card p-4 border-t-4 border-orange-500">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">–ê—É–¥–∞–Ω–¥—ã“õ</p>
                    <h4 id="stat-dist" class="text-xl font-black text-slate-800">0</h4>
                </div>
            </div>

            <div class="card p-6">
                <div class="flex border-b border-slate-100 mb-6 overflow-x-auto">
                    <button onclick="setRatingView('school')" id="rtab-school" class="rating-tab px-6 py-3 font-bold text-sm active">–ú–µ–∫—Ç–µ–ø—Ç–µ—Ä</button>
                    <button onclick="setRatingView('teacher')" id="rtab-teacher" class="rating-tab px-6 py-3 font-bold text-sm">–ú“±“ì–∞–ª—ñ–º–¥–µ—Ä</button>
                    <button onclick="setRatingView('student')" id="rtab-student" class="rating-tab px-6 py-3 font-bold text-sm">–û“õ—É—à—ã–ª–∞—Ä</button>
                </div>
                
                <div class="mb-6 flex flex-wrap gap-2 items-center">
                    <span class="text-xs font-bold text-slate-400">–°“Æ–ó–ì–Ü:</span>
                    <input type="checkbox" id="f-intl" class="filter-checkbox hidden" checked onchange="renderAll()"><label for="f-intl" class="px-3 py-1.5 rounded-full border text-[10px] font-bold cursor-pointer transition-all">–•–ê–õ–´“ö–ê–†.</label>
                    <input type="checkbox" id="f-rep" class="filter-checkbox hidden" checked onchange="renderAll()"><label for="f-rep" class="px-3 py-1.5 rounded-full border text-[10px] font-bold cursor-pointer transition-all">–†–ï–°–ü–£–ë.</label>
                    <input type="checkbox" id="f-reg" class="filter-checkbox hidden" checked onchange="renderAll()"><label for="f-reg" class="px-3 py-1.5 rounded-full border text-[10px] font-bold cursor-pointer transition-all">–û–ë–õ–´–°.</label>
                    <input type="checkbox" id="f-dist" class="filter-checkbox hidden" checked onchange="renderAll()"><label for="f-dist" class="px-3 py-1.5 rounded-full border text-[10px] font-bold cursor-pointer transition-all">–ê–£–î–ê–ù.</label>
                </div>

                <div id="rating-list-container" class="space-y-3"></div>
            </div>
        </section>
    </main>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl opacity-0 transition-all z-[70] pointer-events-none"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    let db = null;
    let auth = null;
    let appId = typeof __app_id !== 'undefined' ? __app_id : "marapat-district-app";
    let data = { schools: [], teachers: [], students: [], achievements: [] };
    let currentRatingView = 'school';
    let currentOwnerType = 'student';

    const startApp = async () => {
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) setupListeners();
            });
        } catch (e) { console.error("Firebase “õ–∞—Ç–µ—Å—ñ:", e); }
    };

    const setupListeners = () => {
        if (!db || !auth.currentUser) return;
        const getCollRef = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const errHandler = (err) => console.error("Firestore “õ–∞—Ç–µ—Å—ñ:", err);

        onSnapshot(getCollRef('schools'), s => { data.schools = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); }, errHandler);
        onSnapshot(getCollRef('teachers'), s => { data.teachers = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); }, errHandler);
        onSnapshot(getCollRef('students'), s => { data.students = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); }, errHandler);
        onSnapshot(getCollRef('achievements'), s => { data.achievements = s.docs.map(d => ({id:d.id, ...d.data()})); renderAll(); }, errHandler);
    };

    window.switchTab = (id) => {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById(`tab-${id}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
        const activeLink = Array.from(document.querySelectorAll('.sidebar-link')).find(b => b.getAttribute('onclick').includes(id));
        if (activeLink) activeLink.classList.add('active');
        if (window.innerWidth < 768) document.getElementById('sidebar').classList.add('hidden');
    };

    window.setRatingView = (v) => {
        currentRatingView = v;
        document.querySelectorAll('.rating-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`rtab-${v}`).classList.add('active');
        renderAll();
    };

    window.setOwnerType = (type) => {
        currentOwnerType = type;
        const sBtn = document.getElementById('btn-type-student');
        const tBtn = document.getElementById('btn-type-teacher');
        
        if (type === 'student') {
            sBtn.className = "flex-1 py-2 px-4 rounded-lg border-2 border-blue-600 bg-blue-600 text-white font-bold transition-all";
            tBtn.className = "flex-1 py-2 px-4 rounded-lg border-2 border-slate-200 text-slate-400 font-bold transition-all";
        } else {
            tBtn.className = "flex-1 py-2 px-4 rounded-lg border-2 border-green-600 bg-green-600 text-white font-bold transition-all";
            sBtn.className = "flex-1 py-2 px-4 rounded-lg border-2 border-slate-200 text-slate-400 font-bold transition-all";
        }
        updateOwnerList();
    };

    window.updateOwnerList = () => {
        const schoolName = document.getElementById('sel-school-filter').value;
        const ownerSelect = document.getElementById('sel-owner-final');
        
        if (!schoolName) {
            ownerSelect.innerHTML = '<option value="">–ê–ª–¥—ã–º–µ–Ω –º–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑...</option>';
            return;
        }

        const source = currentOwnerType === 'student' ? data.students : data.teachers;
        const filtered = source.filter(item => item.school === schoolName).sort((a,b) => a.name.localeCompare(b.name));

        if (filtered.length === 0) {
            ownerSelect.innerHTML = `<option value="">–ë“±–ª –º–µ–∫—Ç–µ–ø—Ç–µ ${currentOwnerType === 'student' ? '–æ“õ—É—à—ã–ª–∞—Ä' : '–º“±“ì–∞–ª—ñ–º–¥–µ—Ä'} —Ç–∞–±—ã–ª–º–∞–¥—ã</option>`;
        } else {
            ownerSelect.innerHTML = '<option value="">–ê–¥–∞–º–¥—ã —Ç–∞“£–¥–∞“£—ã–∑...</option>' + 
                filtered.map(o => `<option value="${o.name}|${o.school}">${o.name}</option>`).join('');
        }
    };

    window.saveToCloud = async (type) => {
        if (!db || !auth.currentUser) return;
        let val = ""; let payload = {};
        
        if (type === 'schools') {
            val = document.getElementById('in-school').value.trim();
            payload = { name: val };
        } else if (type === 'teachers') {
            val = document.getElementById('in-teacher-name').value.trim();
            const school = document.getElementById('sel-school-teacher').value;
            if (!school) { showToast("–ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑"); return; }
            payload = { name: val, school: school };
        } else if (type === 'students') {
            val = document.getElementById('in-student-name').value.trim();
            const school = document.getElementById('sel-school-student').value;
            if (!school) { showToast("–ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑"); return; }
            payload = { name: val, school: school };
        }

        if (val) {
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', type), payload);
                showToast("–°–∞“õ—Ç–∞–ª–¥—ã");
                document.querySelectorAll('input').forEach(i => i.value = "");
            } catch (e) { showToast("“ö–∞—Ç–µ: " + e.message); }
        }
    };

    window.registerAchievement = async () => {
        if (!db || !auth.currentUser) return;
        const ownerInfo = document.getElementById('sel-owner-final').value;
        const comp = document.getElementById('in-comp-name').value.trim();
        
        if (!ownerInfo || !comp) {
            showToast("”®—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑");
            return;
        }

        const [ownerName, school] = ownerInfo.split('|');

        const payload = {
            school: school,
            ownerName: ownerName,
            competitionName: comp,
            score: parseInt(document.getElementById('sel-level').value),
            level: document.getElementById('sel-level').options[document.getElementById('sel-level').selectedIndex].text.split(' ')[0],
            ownerType: currentOwnerType, 
            timestamp: Date.now()
        };

        try {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'achievements'), payload);
            showToast("–ñ–µ—Ç—ñ—Å—Ç—ñ–∫ —Ç—ñ—Ä–∫–µ–ª–¥—ñ");
            switchTab('dashboard');
            document.getElementById('in-comp-name').value = "";
            document.getElementById('sel-school-filter').value = "";
            updateOwnerList();
        } catch (e) { showToast("“ö–∞—Ç–µ: " + e.message); }
    };

    window.removeItem = async (coll, id) => {
        if (db && auth.currentUser && confirm('”®—à—ñ—Ä—É–¥—ñ —Ä–∞—Å—Ç–∞–π—Å—ã–∑ –±–∞?')) {
            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', coll, id));
        }
    };

    window.renderAll = () => {
        if (!document.getElementById('stat-students')) return;

        document.getElementById('stat-students').innerText = data.students.length;
        document.getElementById('stat-teachers').innerText = data.teachers.length;
        document.getElementById('stat-achievements').innerText = data.achievements.length;
        document.getElementById('stat-schools').innerText = data.schools.length;

        const schSorted = [...data.schools].sort((a,b) => a.name.localeCompare(b.name));
        const schOpts = '<option value="">–ú–µ–∫—Ç–µ–ø—Ç—ñ —Ç–∞“£–¥–∞“£—ã–∑</option>' + schSorted.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        ['sel-school-teacher', 'sel-school-student', 'sel-school-filter'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const curVal = el.value;
                el.innerHTML = schOpts;
                el.value = curVal;
            }
        });

        document.getElementById('list-schools').innerHTML = data.schools.map(s => `<li class="p-2 border rounded flex justify-between bg-white text-xs items-center"><span class="truncate">${s.name}</span><button onclick="removeItem('schools','${s.id}')">‚ùå</button></li>`).join('');
        document.getElementById('list-teachers').innerHTML = data.teachers.map(t => `<li class="p-2 border rounded flex justify-between bg-white text-xs items-center"><div><b>${t.name}</b><br><small>${t.school}</small></div><button onclick="removeItem('teachers','${t.id}')">‚ùå</button></li>`).join('');
        document.getElementById('list-students').innerHTML = data.students.map(s => `<li class="p-2 border rounded flex justify-between bg-white text-xs items-center"><div><b>${s.name}</b><br><small>${s.school}</small></div><button onclick="removeItem('students','${s.id}')">‚ùå</button></li>`).join('');

        // --- –†–ï–ô–¢–ò–ù–ì–¢–ï–†–î–Ü –ï–ö–®–ï–£ –õ–û–ì–ò–ö–ê–°–´ ---
        const filters = { 
            '–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ': document.getElementById('f-intl').checked, 
            '–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ': document.getElementById('f-rep').checked, 
            '–û–±–ª—ã—Å—Ç—ã“õ': document.getElementById('f-reg').checked, 
            '–ê—É–¥–∞–Ω–¥—ã“õ': document.getElementById('f-dist').checked 
        };

        const res = {};
        data.achievements.filter(a => {
            // –î–µ“£–≥–µ–π —Å“Ø–∑–≥—ñ—Å—ñ
            const levelMatch = filters[a.level];
            
            // –¢“Æ–† –°“Æ–ó–ì–Ü–°–Ü (–ú“±“ì–∞–ª—ñ–º/–û“õ—É—à—ã –±”©–ª–µ–∫ –∫”©—Ä—Å–µ—Ç—É “Ø—à—ñ–Ω)
            // –ï–≥–µ—Ä –º–µ–∫—Ç–µ–ø —Ä–µ–π—Ç–∏–Ω–≥—ñ –±–æ–ª—Å–∞ - –±–∞—Ä–ª—ã“ì—ã–Ω “õ–æ—Å–∞–º—ã–∑. 
            // –ï–≥–µ—Ä –º“±“ì–∞–ª—ñ–º/–æ“õ—É—à—ã —Ä–µ–π—Ç–∏–Ω–≥—ñ –±–æ–ª—Å–∞ - —Ç–µ–∫ —Å–æ–ª —Ç“Ø—Ä–¥—ñ –∞–ª–∞–º—ã–∑.
            let typeMatch = true;
            if (currentRatingView === 'teacher') typeMatch = (a.ownerType === 'teacher');
            if (currentRatingView === 'student') typeMatch = (a.ownerType === 'student');
            
            return levelMatch && typeMatch;
        }).forEach(a => {
            const key = currentRatingView === 'school' ? a.school : a.ownerName;
            if (key) {
                // –ï–≥–µ—Ä –∞–¥–∞–º–¥–∞—Ä —Ä–µ–π—Ç–∏–Ω–≥—ñ –±–æ–ª—Å–∞, –º–µ–∫—Ç–µ–ø –∞—Ç—ã–Ω –∂–∞–Ω—ã–Ω–∞ “õ–æ—Å—ã–ø “õ–æ—è–º—ã–∑
                const displayKey = currentRatingView === 'school' ? key : `${key} (${a.school})`;
                res[displayKey] = (res[displayKey] || 0) + a.score;
            }
        });

        const sorted = Object.entries(res).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list-container').innerHTML = sorted.map((r, i) => `
            <div class="flex justify-between items-center p-4 bg-white border rounded-xl rating-item shadow-sm">
                <div class="flex items-center space-x-3">
                    <span class="font-bold ${i < 3 ? 'text-blue-600' : 'text-slate-400'}">#${i+1}</span>
                    <span class="font-medium text-slate-700">${r[0]}</span>
                </div>
                <div class="font-black text-blue-600">${r[1]} <small class="text-slate-400">–ë</small></div>
            </div>
        `).join('') || '<p class="text-center text-slate-400 py-10">–ë“±–ª —Å–∞–Ω–∞—Ç—Ç–∞ –º”ô–ª—ñ–º–µ—Ç –∂–æ“õ</p>';

        // –°–æ“£“ì—ã ”ô—Ä–µ–∫–µ—Ç—Ç–µ—Ä –∫–µ—Å—Ç–µ—Å—ñ
        document.getElementById('activity-table').innerHTML = [...data.achievements].sort((a,b) => b.timestamp - a.timestamp).slice(0, 10).map(a => `
            <tr>
                <td class="px-6 py-3"><b>${a.ownerName}</b><br><small class="text-slate-400">${a.competitionName}</small></td>
                <td class="px-6 py-3">${a.school}</td>
                <td class="px-6 py-3 text-center">
                    <span class="px-2 py-1 rounded text-[10px] font-bold ${a.ownerType === 'teacher' ? 'bg-green-100 text-green-700' : 'bg-purple-100 text-purple-700'}">
                        ${a.ownerType === 'teacher' ? '–ú“∞“í–ê–õ–Ü–ú' : '–û“ö–£–®–´'}
                    </span>
                </td>
                <td class="px-6 py-3 text-right font-bold text-blue-600">${a.score}</td>
                <td class="px-6 py-3 text-center"><button onclick="removeItem('achievements','${a.id}')">üóëÔ∏è</button></td>
            </tr>
        `).join('');
        
        document.getElementById('stat-intl').innerText = data.achievements.filter(a => a.level.includes('–•–∞–ª—ã“õ–∞—Ä–∞–ª—ã“õ')).length;
        document.getElementById('stat-rep').innerText = data.achievements.filter(a => a.level.includes('–†–µ—Å–ø—É–±–ª–∏–∫–∞–ª—ã“õ')).length;
        document.getElementById('stat-reg').innerText = data.achievements.filter(a => a.level.includes('–û–±–ª—ã—Å—Ç—ã“õ')).length;
        document.getElementById('stat-dist').innerText = data.achievements.filter(a => a.level.includes('–ê—É–¥–∞–Ω–¥—ã“õ')).length;
    };

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.classList.add('opacity-100');
        setTimeout(() => t.classList.remove('opacity-100'), 3000);
    }

    startApp();
</script>
</body>
</html>
