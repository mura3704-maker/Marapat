<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>МАРАПАТ - Аудандық платформа</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar-link.active { background-color: #3b82f6; color: white; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .tab-content { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

<div id="app" class="flex flex-col md:flex-row min-h-screen">
    <!-- Mobile Header -->
    <div class="md:hidden bg-white border-b p-4 flex justify-between items-center">
        <h1 class="font-bold text-blue-600">МАРАПАТ</h1>
        <button onclick="toggleMobileMenu()" class="text-slate-600"><i class="fas fa-bars"></i></button>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-full md:w-64 bg-white border-r border-slate-200 p-4 space-y-4 hidden md:block">
        <div class="hidden md:flex items-center space-x-2 px-4 py-6">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i class="fas fa-award text-2xl"></i>
            </div>
            <h1 class="text-xl font-bold text-slate-800">МАРАПАТ</h1>
        </div>
        
        <nav class="space-y-1" id="main-nav">
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 transition-all">
                <i class="fas fa-chart-pie w-5"></i><span>Басты бет</span>
            </button>
            <button onclick="switchTab('database')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 transition-all">
                <i class="fas fa-database w-5"></i><span>Базаны толтыру</span>
            </button>
            <button onclick="switchTab('add-achievement')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 transition-all">
                <i class="fas fa-plus-circle w-5"></i><span>Жетістік қосу</span>
            </button>
            <button onclick="switchTab('ratings')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 transition-all">
                <i class="fas fa-trophy w-5"></i><span>Рейтингтер</span>
            </button>
            <button onclick="switchTab('settings')" class="sidebar-link w-full text-left px-4 py-3 rounded-xl flex items-center space-x-3 text-slate-600 hover:bg-slate-100 transition-all">
                <i class="fas fa-cog w-5"></i><span>Баптаулар</span>
            </button>
        </nav>
    </aside>

    <main class="flex-1 p-4 md:p-8 overflow-y-auto">
        <!-- Dashboard -->
        <section id="tab-dashboard" class="tab-content space-y-6 pb-12">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card p-6 border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-slate-500">Оқушылар</p>
                    <h3 id="stat-students" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm font-medium text-slate-500">Мұғалімдер</p>
                    <h3 id="stat-teachers" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-purple-500">
                    <p class="text-sm font-medium text-slate-500">Жетістіктер</p>
                    <h3 id="stat-achievements" class="text-2xl font-bold mt-1">0</h3>
                </div>
                <div class="card p-6 border-l-4 border-orange-500">
                    <p class="text-sm font-medium text-slate-500">Мектептер</p>
                    <h3 id="stat-schools" class="text-2xl font-bold mt-1">0</h3>
                </div>
            </div>

            <div class="card overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 font-bold text-slate-800">Соңғы жетістіктер</div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="px-6 py-3">Иесі / Жарыс</th>
                                <th class="px-6 py-3">Мектеп</th>
                                <th class="px-6 py-3">Деңгей</th>
                                <th class="px-6 py-3 text-right">Балл</th>
                                <th class="px-6 py-3 text-center">Әрекет</th>
                            </tr>
                        </thead>
                        <tbody id="activity-table" class="divide-y divide-slate-100 text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Database -->
        <section id="tab-database" class="tab-content hidden space-y-6 pb-12">
             <h2 class="text-2xl font-bold text-slate-800">Базаны басқару</h2>
             <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Schools -->
                <div class="card p-6 flex flex-col h-[500px]">
                    <h3 class="font-bold mb-4 text-blue-600"><i class="fas fa-school mr-2"></i> Мектептер</h3>
                    <div class="flex space-x-2 mb-4">
                        <input id="in-school" type="text" placeholder="Мектеп аты" class="flex-1 border p-2 rounded text-sm outline-none focus:border-blue-500">
                        <button onclick="saveLocal('schools')" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">Қосу</button>
                    </div>
                    <ul id="list-schools" class="flex-1 overflow-y-auto space-y-1 text-sm"></ul>
                </div>
                <!-- Teachers -->
                <div class="card p-6 flex flex-col h-[500px]">
                    <h3 class="font-bold mb-4 text-green-600"><i class="fas fa-chalkboard-teacher mr-2"></i> Мұғалімдер</h3>
                    <div class="space-y-2 mb-4">
                        <select id="sel-school-teacher" class="w-full border p-2 rounded text-sm"></select>
                        <input id="in-teacher-name" type="text" placeholder="Аты-жөні" class="w-full border p-2 rounded text-sm outline-none focus:border-green-500">
                        <select id="sel-teacher-cat" class="w-full border p-2 rounded text-sm">
                            <option value="Шебер">Шебер</option>
                            <option value="Зерттеуші">Зерттеуші</option>
                            <option value="Сарапшы">Сарапшы</option>
                            <option value="Модератор">Модератор</option>
                            <option value="Педагог">Педагог</option>
                        </select>
                        <button onclick="saveLocal('teachers')" class="w-full bg-green-600 text-white py-2 rounded text-sm hover:bg-green-700">Сақтау</button>
                    </div>
                    <ul id="list-teachers" class="flex-1 overflow-y-auto space-y-1 text-sm"></ul>
                </div>
                <!-- Students -->
                <div class="card p-6 flex flex-col h-[500px]">
                    <h3 class="font-bold mb-4 text-purple-600"><i class="fas fa-user-graduate mr-2"></i> Оқушылар</h3>
                    <div class="space-y-2 mb-4">
                        <select id="sel-school-student" class="w-full border p-2 rounded text-sm"></select>
                        <input id="in-student-name" type="text" placeholder="Аты-жөні" class="w-full border p-2 rounded text-sm outline-none focus:border-purple-500">
                        <input id="in-student-class" type="number" placeholder="Сыныбы" class="w-full border p-2 rounded text-sm outline-none">
                        <button onclick="saveLocal('students')" class="w-full bg-purple-600 text-white py-2 rounded text-sm hover:bg-purple-700">Сақтау</button>
                    </div>
                    <ul id="list-students" class="flex-1 overflow-y-auto space-y-1 text-sm"></ul>
                </div>
             </div>
        </section>

        <!-- Achievement -->
        <section id="tab-add-achievement" class="tab-content hidden max-w-xl mx-auto pb-12">
            <div class="card p-8 space-y-6">
                <h2 class="text-2xl font-bold text-center">Жетістікті тіркеу</h2>
                <div class="flex bg-slate-100 p-1 rounded-xl" id="type-switcher">
                    <button onclick="setType('student')" id="btn-type-student" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all bg-white shadow">Оқушы</button>
                    <button onclick="setType('teacher')" id="btn-type-teacher" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all">Мұғалім</button>
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-slate-700">Мектепті таңдаңыз</label>
                    <select id="sel-school-final" onchange="updateTargets()" class="w-full border p-3 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"></select>
                    
                    <label class="block text-sm font-medium text-slate-700">Кімге тіркеледі?</label>
                    <select id="sel-target-final" class="w-full border p-3 rounded-lg outline-none"></select>
                    
                    <label class="block text-sm font-medium text-slate-700">Жарыс атауы</label>
                    <input id="in-comp-name" type="text" placeholder="Мысалы: Олимпиада-2024" class="w-full border p-3 rounded-lg outline-none">
                    
                    <label class="block text-sm font-medium text-slate-700">Деңгей (Балл)</label>
                    <select id="sel-level" class="w-full border p-3 rounded-lg outline-none">
                        <option value="100">Халықаралық (100 балл)</option>
                        <option value="80">Республикалық (80 балл)</option>
                        <option value="60">Облыстық (60 балл)</option>
                        <option value="40">Аудандық (40 балл)</option>
                    </select>
                    <button onclick="addAchievementLocal()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-blue-700 transition-all">Тіркеуді сақтау</button>
                </div>
            </div>
        </section>

        <!-- Ratings -->
        <section id="tab-ratings" class="tab-content hidden space-y-6">
            <h2 class="text-2xl font-bold text-slate-800">Мектептер рейтингі</h2>
            <div id="rating-list" class="space-y-3"></div>
        </section>

        <!-- Settings -->
        <section id="tab-settings" class="tab-content hidden space-y-6 pb-12">
            <div class="card p-8">
                <h2 class="text-2xl font-bold mb-6">Деректерді басқару</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="exportData()" class="bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-blue-700">
                        <i class="fas fa-file-export mr-2"></i> Экспорт (.json)
                    </button>
                    <label class="bg-green-600 text-white p-4 rounded-xl font-bold text-center cursor-pointer hover:bg-green-700">
                        <i class="fas fa-file-import mr-2"></i> Импорт
                        <input type="file" id="importFile" class="hidden" onchange="importData(event)">
                    </label>
                </div>
                <button onclick="clearAllData()" class="mt-8 text-red-500 text-sm font-medium hover:underline">Барлық деректі өшіру</button>
            </div>
        </section>
    </main>
</div>

<div id="toast" class="fixed bottom-5 right-5 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl opacity-0 transition-all duration-300 pointer-events-none"></div>

<script>
    // Database initialization
    let db = JSON.parse(localStorage.getItem('marapat_db')) || { 
        schools: [], teachers: [], students: [], achievements: [] 
    };
    let currentType = 'student';

    // UI functions
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.getElementById('tab-' + id).classList.remove('hidden');
        
        document.querySelectorAll('.sidebar-link').forEach(l => {
            l.classList.remove('active');
            if(l.getAttribute('onclick').includes(id)) l.classList.add('active');
        });

        if(window.innerWidth < 768) {
            document.getElementById('sidebar').classList.add('hidden');
        }
        renderAll();
    }

    function toggleMobileMenu() {
        document.getElementById('sidebar').classList.toggle('hidden');
    }

    function setType(type) {
        currentType = type;
        const btnS = document.getElementById('btn-type-student');
        const btnT = document.getElementById('btn-type-teacher');
        
        if(type === 'student') {
            btnS.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow";
            btnT.className = "flex-1 py-2 rounded-lg text-sm font-bold";
        } else {
            btnT.className = "flex-1 py-2 rounded-lg text-sm font-bold bg-white shadow";
            btnS.className = "flex-1 py-2 rounded-lg text-sm font-bold";
        }
        updateTargets();
    }

    // CRUD functions
    function saveLocal(type) {
        let entry = { id: Date.now() };
        if(type === 'schools') {
            const name = document.getElementById('in-school').value;
            if(!name) return;
            entry.name = name;
            document.getElementById('in-school').value = "";
        }
        if(type === 'teachers') {
            const name = document.getElementById('in-teacher-name').value;
            if(!name) return;
            entry.name = name;
            entry.school = document.getElementById('sel-school-teacher').value;
            entry.category = document.getElementById('sel-teacher-cat').value;
            document.getElementById('in-teacher-name').value = "";
        }
        if(type === 'students') {
            const name = document.getElementById('in-student-name').value;
            if(!name) return;
            entry.name = name;
            entry.school = document.getElementById('sel-school-student').value;
            entry.class = document.getElementById('in-student-class').value;
            document.getElementById('in-student-name').value = "";
        }
        
        db[type].push(entry);
        sync();
    }

    function addAchievementLocal() {
        const sch = document.getElementById('sel-school-final').value;
        const targetId = document.getElementById('sel-target-final').value;
        const comp = document.getElementById('in-comp-name').value;
        const score = parseInt(document.getElementById('sel-level').value);
        
        if(!sch || !targetId || !comp) return showToast("Барлық өрісті толтырыңыз");

        const list = currentType === 'student' ? db.students : db.teachers;
        const target = list.find(x => x.id == targetId);

        db.achievements.push({
            id: Date.now(),
            ownerName: target ? target.name : "Белгісіз",
            school: sch,
            competitionName: comp,
            score: score,
            level: document.getElementById('sel-level').options[document.getElementById('sel-level').selectedIndex].text.split(' ')[0],
            timestamp: Date.now()
        });
        
        document.getElementById('in-comp-name').value = "";
        sync();
        switchTab('dashboard');
    }

    function remove(type, id) {
        if(!confirm("Өшіруді растайсыз ба?")) return;
        db[type] = db[type].filter(x => x.id != id);
        sync();
    }

    function sync() {
        localStorage.setItem('marapat_db', JSON.stringify(db));
        renderAll();
        showToast("Деректер жаңартылды");
    }

    function updateTargets() {
        const sch = document.getElementById('sel-school-final').value;
        const list = currentType === 'student' ? db.students : db.teachers;
        const filtered = list.filter(x => x.school === sch);
        const sel = document.getElementById('sel-target-final');
        if(filtered.length === 0) {
            sel.innerHTML = '<option value="">Тізім бос (Алдымен базаға қосыңыз)</option>';
        } else {
            sel.innerHTML = filtered.map(x => `<option value="${x.id}">${x.name} ${x.class ? '('+x.class+' сынып)' : ''}</option>`).join('');
        }
    }

    function renderAll() {
        // Stats
        document.getElementById('stat-students').innerText = db.students.length;
        document.getElementById('stat-teachers').innerText = db.teachers.length;
        document.getElementById('stat-schools').innerText = db.schools.length;
        document.getElementById('stat-achievements').innerText = db.achievements.length;

        // School dropdowns
        const schOpt = db.schools.length > 0 
            ? db.schools.map(x => `<option value="${x.name}">${x.name}</option>`).join('')
            : '<option value="">Мектептер жоқ</option>';
        
        ['sel-school-teacher', 'sel-school-student', 'sel-school-final'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                const currentVal = el.value;
                el.innerHTML = schOpt;
                if(currentVal) el.value = currentVal;
            }
        });

        // Lists in Database tab
        document.getElementById('list-schools').innerHTML = db.schools.map(x => `
            <li class="p-2 border-b flex justify-between items-center group">
                <span>${x.name}</span>
                <button onclick="remove('schools', ${x.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
            </li>
        `).join('');

        document.getElementById('list-teachers').innerHTML = db.teachers.map(x => `
            <li class="p-2 border-b flex justify-between items-center group text-xs">
                <div><b>${x.name}</b><br><span class="text-slate-400">${x.school}</span></div>
                <button onclick="remove('teachers', ${x.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
            </li>
        `).join('');

        document.getElementById('list-students').innerHTML = db.students.map(x => `
            <li class="p-2 border-b flex justify-between items-center group text-xs">
                <div><b>${x.name}</b> (${x.class} сынып)<br><span class="text-slate-400">${x.school}</span></div>
                <button onclick="remove('students', ${x.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash-alt"></i></button>
            </li>
        `).join('');

        // Main Activity Table
        document.getElementById('activity-table').innerHTML = db.achievements.slice().reverse().slice(0, 15).map(a => `
            <tr class="text-sm border-b hover:bg-slate-50">
                <td class="px-6 py-4"><b>${a.ownerName}</b><br><small class="text-slate-500">${a.competitionName}</small></td>
                <td class="px-6 py-4">${a.school}</td>
                <td class="px-6 py-4"><span class="px-2 py-1 bg-blue-50 text-blue-600 rounded text-[10px] font-bold">${a.level}</span></td>
                <td class="px-6 py-4 text-right font-bold text-blue-600">+${a.score}</td>
                <td class="px-6 py-4 text-center">
                    <button onclick="remove('achievements', ${a.id})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');

        // Ratings Logic
        const scores = {};
        db.schools.forEach(s => scores[s.name] = 0);
        db.achievements.forEach(a => {
            if(scores[a.school] !== undefined) scores[a.school] += a.score;
        });

        const sorted = Object.entries(scores).sort((a,b) => b[1] - a[1]);
        document.getElementById('rating-list').innerHTML = sorted.map(([name, score], i) => `
            <div class="card p-4 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-8 h-8 ${i < 3 ? 'bg-yellow-400' : 'bg-slate-100'} rounded-full flex items-center justify-center font-bold text-sm">
                        ${i + 1}
                    </div>
                    <span class="font-bold">${name}</span>
                </div>
                <div class="text-blue-600 font-bold text-lg">${score} <small class="text-xs text-slate-400">балл</small></div>
            </div>
        `).join('');
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const a = document.createElement('a');
        a.href = dataStr; a.download = "marapat_data.json";
        a.click();
    }

    function importData(e) {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                db = JSON.parse(event.target.result);
                sync();
                showToast("Импорт сәтті аяқталды");
            } catch(err) { showToast("Қате файл форматы"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    function clearAllData() {
        if(confirm("Назар аударыңыз! Барлық мәлімет жойылады. Жалғастырамыз ба?")) {
            db = { schools: [], teachers: [], students: [], achievements: [] };
            sync();
        }
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.style.opacity = '1';
        setTimeout(() => t.style.opacity = '0', 3000);
    }

    // Initial load
    renderAll();
    updateTargets();
</script>
</body>
</html>
